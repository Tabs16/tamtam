instr 105
/* soundfile play control 
   p4 : filename 
   p5 : unique instance ID
   p6 : pitch
   p7 : output gain (0-1)
   p8 : reverb send gain (0-1)
   p9 : table number
   p10: duration
   p11: note gain
   p12: pan

   channels:
   sfplay.<ID>.on  - instance control channel (1:on 0: off)
   sfplay.<ID>.gain - soundfile play gain (0-1)
   sfplay.<ID>.flen  - holds the channel length
*/

;S1 strget p4
inst = p5
ipit = p6
igain = p7
irevgain = p8
itab = p9
idur = p10
inotegain = p11
ipan = p12

;iln    filelen  S1
;iln = iln/ipit

Splay sprintf "sfplay.%d.on", inst  ; instance control channel
;Sname sprintf "sfplay.%d.fname", inst  ; filename channel 
;Sgain sprintf "sfplay.%d.gain", inst ; gain channel  

;chnset S1, Sname
chnset 1,  Splay
;chnset p7, Sgain

event_i "i",106,0,idur,inst,itab, ipit, igain, irevgain, inotegain, ipan
turnoff 
endin


instr 106
/* soundfile player 
   This is the actual soundfile player. 
   It never gets called directly
*/

inst = p4
itab = p5
ipit = p6
igain = p7
irg = p8
inotegain = p9
ipan = p10

Splay sprintf "sfplay.%d.on", inst  ; instance control channel
;Sname sprintf "sfplay.%d.fname", inst  ; filename channel 
;Sgain sprintf "sfplay.%d.gain", inst ; gain channel

   
kon chnget Splay
;kg1 chnget Sgain
;S1  chnget Sname


if kon == 0 then
;printf "sfplay:%d OFF\n", 1, inst
turnoff
endif

a1        loscil    1, ipit, itab, 1
a2 = a1

kenv linen 1, 0.001, p3, 0.01
      outs a1*igain*kenv*inotegain*(1-ipan), a2*igain*kenv*inotegain*ipan

gainrev	=	(a1+a2)*irg*kenv*.5*inotegain

;printf_i "sfplay:%d\n", 1, inst
endin 
